@using Microsoft.AspNetCore.Identity
@using WebApp.ViewModels
@inject SignInManager<Users> signInManager
@inject UserManager<Users> userManager

@model List<WebApp.Models.RoomAppointment>

@{
    ViewData["Title"] = "NEU Care | Dashboard";
    Layout = "~/Views/Shared/Layouts/_DashboardLayout.cshtml";

    var user = await userManager.GetUserAsync(User);
    var name = user?.FullName ?? user?.UserName ?? "Guest";

    // Fetch roles for the current user
    var roles = user != null ? await userManager.GetRolesAsync(user) : new List<string>();
    var role = roles.Any() ? string.Join(", ", roles) : "No Role Assigned";

    // Initialize role flags
    var isSuperAdmin = roles.Contains("SuperAdmin");
    var isAdmin = roles.Contains("Admin");
    var isMedicalStaff = roles.Contains("MedicalStaff");
    var isStudent = roles.Contains("Student");

    // Set userRole based on the highest priority role
    var userRole = "Student";
    if (isSuperAdmin)
    {
        userRole = "SuperAdmin";
    }
    else if (isAdmin)
    {
        userRole = "Admin";
    }
    else if (isMedicalStaff)
    {
        userRole = "MedicalStaff";
    }
    else if (isStudent)
    {
        userRole = "Student";
    }

    var activeTab = ViewBag.ActiveTab ?? "home";
}

<div class="d-flex" id="wrapper">
    <div class="bg-dark border-end" id="sidebar-wrapper">
        <div class="bg-primary text-white p-3 sidebar-header d-flex flex-column flex-sm-row align-items-center">
            <h4 class="m-0 sidebar-text text-nowrap">
                <i class="fas fa-heartbeat me-2"></i>Dashboard
            </h4>
            <button class="btn text-white border-0 toggle-btn d-flex justify-content-center align-items-center"
                id="menu-toggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <div class="list-group list-group-flush mt-3 sidebar-content">
            <a href="@Url.Action("Index", "Dashboard", new { activeTab = "home" })"
                class="list-group-item list-group-item-action bg-dark text-white d-flex align-items-center @(activeTab == "home" ? "active" : "")"
                data-tab="home">
                <i class="fas fa-home"></i><span class="sidebar-text ms-2">Home</span>
            </a>
            @if (!isSuperAdmin)
            {
                <a href="@Url.Action("Index", "Dashboard", new { activeTab = "profile" })"
                    class="list-group-item list-group-item-action bg-dark text-white d-flex align-items-center @(activeTab == "profile" ? "active" : "")"
                    data-tab="profile">
                    <i class="fas fa-user"></i><span class="sidebar-text ms-2">Profile</span>
                </a>
            }
            <a href="@Url.Action("Index", "Dashboard", new { activeTab = "qrscanner" })"
                class="list-group-item list-group-item-action bg-dark text-white d-flex align-items-center @(activeTab == "qrscanner" ? "active" : "")"
                data-tab="qrscanner">
                <i class="fas fa-qrcode"></i><span class="sidebar-text ms-2">QR Scanner</span>
            </a>
            @if (isStudent)
            {
                <a href="@Url.Action("Index", "Dashboard", new { activeTab = "healthrecords" })"
                    class="list-group-item list-group-item-action bg-dark text-white d-flex align-items-center @(activeTab == "healthrecords" ? "active" : "")"
                    data-tab="healthrecords">
                    <i class="fas fa-file-medical"></i><span class="sidebar-text ms-2">Submit Health Records</span>
                </a>
            }
            @if (isStudent)
            {
                <a href="@Url.Action("Index", "Dashboard", new { activeTab = "appointments" })"
                    class="list-group-item list-group-item-action bg-dark text-white d-flex align-items-center @(activeTab == "appointments" ? "active" : "")"
                    data-tab="appointments">
                    <i class="fas fa-calendar-alt"></i><span class="sidebar-text ms-2">Available Appointments</span>
                </a>
                <a href="@Url.Action("Index", "Dashboard", new { activeTab = "personalappointments" })"
                    class="list-group-item list-group-item-action bg-dark text-white d-flex align-items-center @(activeTab == "personalappointments" ? "active" : "")"
                    data-tab="personalappointments">
                    <i class="fas fa-calendar-check"></i><span class="sidebar-text ms-2">Personal Appointments</span>
                </a>
            }
        </div>
    </div>

    <div id="page-content-wrapper" class="w-100">
        <div class="container-fluid p-4">
            <!-- Home Content -->
            <div id="home-content" class="tab-content @(activeTab == "home" ? "active" : "")"
                style="display: @(activeTab == "home" ? "block" : "none");">
                <!-- Redesigned Welcome Section (matches partials style) -->
                <style>
                    /* Use the unified card style for the welcome card */
                    .welcome-card {
                        background: #fff;
                        border-radius: 1rem !important;
                        border: 1.5px solid var(--bs-primary, #d27510);
                        margin-bottom: 32px;
                        padding: 0;
                        transition: transform 0.2s;
                    }
                    .welcome-card:hover {
                        transform: translateY(-5px);
                    }
                    .welcome-card .section-title {
                        color: var(--bs-primary);
                        border-bottom: 2px solid var(--bs-primary);
                        padding-bottom: 0.5rem;
                        margin-bottom: 1.5rem;
                        font-size: 1.5rem;
                        font-weight: 600;
                    }
                    .welcome-card .card-title {
                        font-size: 2.2rem;
                        font-weight: bold;
                        letter-spacing: -1px;
                        color: var(--bs-primary);
                    }
                    .welcome-card .lead {
                        font-size: 1.15rem;
                        font-weight: 500;
                        color: #343a40;
                    }
                    .welcome-card .badge {
                        font-size: 1rem;
                        padding: 0.6em 1.2em;
                        border-radius: 6px;
                    }
                    .welcome-card .text-muted {
                        color: #6c757d !important;
                    }
                    .welcome-card img {
                        max-width: 160px;
                        border-radius: 10px;
                        background: #fff;
                        padding: 8px;
                    }
                </style>
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card welcome-card border-0">
                            <div class="card-body p-4">
                                <div class="section-title d-flex align-items-center mb-4">
                                    <i class="fas fa-heartbeat me-2"></i>
                                    <span>Welcome</span>
                                    <span class="ms-auto fs-6 text-muted">Updated: @DateTime.Now.ToString("MMM dd, h:mm tt")</span>
                                </div>
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <h1 class="card-title mb-2">
                                            Welcome back, <span class="fw-bold">@name</span>!
                                        </h1>
                                        <p class="lead mb-3">
                                            <i class="fas fa-user-circle me-2"></i>
                                            <span class="fw-semibold">Role:</span>
                                            <span class="badge bg-primary text-white ms-2">
                                                @{
                                                    if (isStudent)
                                                    {
                                                        <text><i class="fas fa-user-graduate me-1"></i> Student</text>
                                                    }
                                                    else if (isSuperAdmin)
                                                    {
                                                        <text><i class="fas fa-user-shield me-1"></i> Super Admin</text>
                                                    }
                                                    else if (isAdmin)
                                                    {
                                                        <text><i class="fas fa-user-tie me-1"></i> Admin</text>
                                                    }
                                                    else if (isMedicalStaff)
                                                    {
                                                        <text><i class="fas fa-user-md me-1"></i> Medical Staff</text>
                                                    }
                                                    else
                                                    {
                                                        @role
                                                    }
                                                }
                                            </span>
                                        </p>
                                        <div class="mt-4">
                                            <span class="text-muted">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Use the sidebar to navigate your dashboard features.
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Redesigned Welcome Section -->

                <!-- Dashboard Cards -->
                @if (isStudent)
                {
                    @await Html.PartialAsync("Partials/_StudentDashboardPartial")
                }
                else if (isSuperAdmin)
                {
                    @await Html.PartialAsync("Partials/_AdminDashboardPartial")
                }
                else if (isAdmin)
                {
                    @await Html.PartialAsync("Partials/_AdminDashboardPartial")
                }
                else if (isMedicalStaff)
                {
                    @await Html.PartialAsync("Partials/_MedicalStaffDashboardPartial")
                }
            </div>

            @if (!isSuperAdmin)
            {
                <div id="profile-content" class="tab-content @(activeTab == "profile" ? "active" : "")"
                    style="display: @(activeTab == "profile" ? "block" : "none");">
                    @await Html.PartialAsync("Profile/_ProfileDashboardPartial")
                </div>
            }

            <div id="qrscanner-content" class="tab-content @(activeTab == "qrscanner" ? "active" : "")"
                style="display: @(activeTab == "qrscanner" ? "block" : "none");">
                @await Html.PartialAsync("QRScanner/_QRScannerPartial")
            </div>

            @if (isStudent)
            {
                <div id="healthrecords-content" class="tab-content @(activeTab == "healthrecords" ? "active" : "")"
                    style="display: @(activeTab == "healthrecords" ? "block" : "none");">
                    @await Html.PartialAsync("SubmittedHealthDetails/_SubmitHealthRecordsPartial", new
                    SubmittedHealthDetailsViewModel())
                </div>
            }

            @if (isStudent)
            {
                <div id="appointments-content" class="tab-content @(activeTab == "appointments" ? "active" : "")"
                    style="display: @(activeTab == "appointments" ? "block" : "none");">
                    @await Html.PartialAsync("AvailableAppointments/_AvailableAppointmentsPartial", Model)
                </div>
                <div id="personalappointments-content" class="tab-content @(activeTab == "personalappointments" ? "active" : "")"
                    style="display: @(activeTab == "personalappointments" ? "block" : "none");">
                    @await Html.PartialAsync("PersonalAppointment/_PersonalAppointmentPartial")
                </div>
            }
        </div>
    </div>
</div>

<script>
    document.getElementById("menu-toggle").addEventListener("click", function () {
        document.getElementById("wrapper").classList.toggle("toggled");
    });

    // Activate the correct tab based on the activeTab value
    const activeTab = "@activeTab";
    const activeTabItem = document.querySelector(`.list-group-item[data-tab="${activeTab}"]`);
    if (activeTabItem) {
        activeTabItem.classList.add('active');
        document.getElementById(`${activeTab}-content`).style.display = 'block';
    }

    // Handle tab clicks
    document.querySelectorAll('.list-group-item').forEach(item => {
        item.addEventListener('click', function (e) {
            e.preventDefault();
            const tab = this.getAttribute('data-tab');

            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });

            // Show the selected tab content
            document.getElementById(`${tab}-content`).style.display = 'block';

            // Update the URL with the active tab
            window.location.href = `@Url.Action("Index", "Dashboard")?activeTab=${tab}`;
        });
    });
</script>
